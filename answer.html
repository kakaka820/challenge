<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>管理画面</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table {
  border-collapse: collapse;
  width: 100%;
  table-layout: auto;
}

th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: center;
  white-space: nowrap; /* これで折り返さない */
}
  th { background-color: #f2f2f2; }
  #loginForm, #dataView { max-width: 400px; margin: auto; }
  #halfSettings { margin-top: 20px; }
  #halfSettings label { margin-right: 10px; }
  

</style>
</head>
<body>
<h1>管理画面</h1>

<div id="loginForm">
  <h2>ログイン</h2>
  <input type="text" id="adminName" placeholder="管理者名"><br><br>
  <input type="password" id="adminPassword" placeholder="パスワード"><br><br>
  <button id="loginBtn">ログイン</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div id="dataView" style="display:none;">
  <!-- 回答一覧は上に固定 -->
  <h2>回答一覧</h2>
  <table id="answersTable">
    <thead>
      <tr>
        <th>名前</th>
        <th>村役</th>
        <th>人狼</th>
        <th>ポイント</th>
        <th>最終更新時間</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- 半減設定 -->
  <div id="halfSettings">
    <h2>半減設定</h2>
    <p>村役</p>
    <div id="halfSet1"></div>
    <p>人外</p>
    <div id="halfSet2"></div>
    <div id="halfDobon"></div>
  </div>

  <!-- 正解セット編集は下に配置 -->
  <h2>正解セット設定</h2>
  <form id="correctForm">
    <div>
      <h3>村役</h3>
      <div id="set1Options"></div>
    </div>
    <div>
      <h3>人狼</h3>
      <div id="set2Options"></div>
    </div>
    <div>
      <h3>狂人</h3>
      <div id="dobonOptions"></div>
    </div>
    <button type="submit">保存</button><div style="margin-bottom: 20px;">
    <button id="resetBtn" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
      全回答をリセット
    </button>
  </div>
    <p id="saveMessage" style="color:green;"></p>
  </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
import { getFirestore, doc, getDoc, collection, getDocs, setDoc } 
from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

async function sha256(str) {
  const encoder = new TextEncoder();
  const data = encoder.encode(str);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
}

const firebaseConfig = {
  apiKey: "AIzaSyDY2qQHODhC5lPN8ybWk4VoCg-ivOMiYrE",
  authDomain: "challenge-59258.firebaseapp.com",
  projectId: "challenge-59258",
  storageBucket: "challenge-59258.firebasestorage.app",
  messagingSenderId: "1035301361775",
  appId: "1:1035301361775:web:e5b29b735dd95d23c1559a",
  measurementId: "G-27VD3GZ7CT"
};
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);

const loginBtn = document.getElementById("loginBtn");
const loginForm = document.getElementById("loginForm");
const dataView = document.getElementById("dataView");
const loginError = document.getElementById("loginError");

const correctForm = document.getElementById("correctForm");
const set1Options = document.getElementById("set1Options");
const set2Options = document.getElementById("set2Options");
const dobonOptions = document.getElementById("dobonOptions");
const saveMessage = document.getElementById("saveMessage");

const halfSet1 = document.getElementById("halfSet1");
const halfSet2 = document.getElementById("halfSet2");
const halfDobon = document.getElementById("halfDobon");

// 数字描画（正解セット用） ← 初回ロードのみ
function renderNumberOptions(selectedSet1 = [], selectedSet2 = [], selectedDobon = null) {
  function makeCheckboxes(container, name, selectedValues) {
    container.innerHTML = "";
    for (let i = 1; i <= 14; i++) {
      const label = document.createElement("label");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.name = name;
      checkbox.value = i;
      if (selectedValues.find(v=>v.num===i)) checkbox.checked = true;
      label.appendChild(checkbox);
      label.append(" " + i + " ");
      container.appendChild(label);
    }
  }

  function makeRadio(container, name, selectedValue) {
    container.innerHTML = "";
    for (let i = 1; i <= 14; i++) {
      const label = document.createElement("label");
      const radio = document.createElement("input");
      radio.type = "radio";
      radio.name = name;
      radio.value = i;
      if (selectedValue===i) radio.checked=true;
      label.appendChild(radio);
      label.append(" " + i + " ");
      container.appendChild(label);
    }
  }

  makeCheckboxes(set1Options, "set1", selectedSet1);
  makeCheckboxes(set2Options, "set2", selectedSet2);
  makeRadio(dobonOptions, "dobon", selectedDobon);
}

// 半減設定UI描画（変更時に再描画しない）
function renderHalfSettings(setArray, container, name) {
  container.innerHTML = "";
  setArray.forEach(item => {
    const label = document.createElement("label");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.name = name + "_" + item.num;
    cb.checked = item.half || false;

    cb.addEventListener("change", async () => {
      const snap = await getDoc(doc(db, "correct", "answers"));
      const data = snap.exists() ? snap.data() : { set1: [], set2: [] };
      const targetArray = name.startsWith("set1") ? data.set1 : data.set2;
      targetArray.forEach(obj => { if (obj.num===item.num) obj.half = cb.checked; });
      await setDoc(doc(db, "correct", "answers"), data);
      // 再描画は不要
    });

    label.appendChild(cb);
    label.append(" " + item.num + " CO済 ");
    container.appendChild(label);
  });
}

function renderDobonHalf(correctData) {
  halfDobon.innerHTML = "";
  const label = document.createElement("label");
  const cb = document.createElement("input");
  cb.type = "checkbox";
  cb.checked = correctData.dobonHalf || false;

  cb.addEventListener("change", async () => {
    const snap = await getDoc(doc(db, "correct", "answers"));
    const data = snap.exists() ? snap.data() : {};
    data.dobonHalf = cb.checked;
    await setDoc(doc(db, "correct", "answers"), data);
    // 再描画は不要
  });

  label.appendChild(cb);
  label.append(" 狂人CO済 ");
  halfDobon.appendChild(label);
}

// Firestoreからロード
async function loadCorrectSet() {
  const correctSnap = await getDoc(doc(db, "correct", "answers"));
  const correctData = correctSnap.exists() ? correctSnap.data() : { set1: [], set2: [], dobon: null };

  // 数字オプション描画
  renderNumberOptions(correctData.set1||[], correctData.set2||[], correctData.dobon||null);
  // 半減設定描画
  renderHalfSettings(correctData.set1||[], halfSet1, "set1_half");
  renderHalfSettings(correctData.set2||[], halfSet2, "set2_half");
  renderDobonHalf(correctData);
}

// 保存処理
correctForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  function gatherSet(name) {
    return Array.from(document.querySelectorAll(`input[name='${name}']:checked`))
      .map(cb => {
        const num = parseInt(cb.value);
        const half = document.querySelector(`input[name^='${name}_half_${num}']`)?.checked || false;
        return { num, half };
      });
  }

  const set1 = gatherSet("set1");
  const set2 = gatherSet("set2");
  const dobonEl = document.querySelector("input[name='dobon']:checked");
  const dobon = dobonEl ? parseInt(dobonEl.value) : null;

  if (set1.length!==3 || set2.length!==3 || dobon===null) {
    alert("Set1は3つ、Set2は3つ、Dobonは1つ選んでください");
    return;
  }

  const snap = await getDoc(doc(db, "correct", "answers"));
  const existingData = snap.exists() ? snap.data() : {};
  const dobonHalf = existingData.dobonHalf || false;
  await setDoc(doc(db, "correct", "answers"), { 
    set1, 
    set2, 
    dobon,
    dobonHalf
  });
  
  saveMessage.textContent = "保存しました！";
  setTimeout(() => saveMessage.textContent = "", 2000);
  loadAnswers();
});

// ログイン
loginBtn.addEventListener("click", async () => {
  const name = document.getElementById("adminName").value.trim();
  const password = document.getElementById("adminPassword").value;
  if (!name || !password) { loginError.textContent="名前とパスワードを入力してください"; return; }
  const hash = await sha256(password);

  const adminRef = doc(db,"admin",name);
  const adminSnap = await getDoc(adminRef);
  if (!adminSnap.exists()) { loginError.textContent="管理者が存在しません"; return; }
  const adminData = adminSnap.data();
  if (adminData.pw!==hash) { loginError.textContent="パスワードが正しくありません"; return; }

  loginForm.style.display="none";
  dataView.style.display="block";
  await loadCorrectSet();
  loadAnswers();
});

// ポイント計算
function calculatePoints(answerArray, correctArray, dobon, correctData) {
  let total=0;
  answerArray.forEach((val, idx)=>{
    const point=[6,4,2][idx];
    const correctItem=correctArray.find(c=>c.num===Number(val));
    if(Number(val)===dobon){
      const dobonHalf=correctData.dobonHalf||false;
      total -= dobonHalf ? Math.ceil(point/2) : point;
    } else if(correctItem){
      total += correctItem.half ? Math.ceil(point/2) : point;
    }
  });
  return total;
}

// 回答表示
async function loadAnswers() {
  const correctSnap = await getDoc(doc(db,"correct","answers"));
  const correctData = correctSnap.exists() ? correctSnap.data() : { set1:[], set2:[], dobon:null };
  const answersSnap = await getDocs(collection(db,"answers"));
  const tbody = document.querySelector("#answersTable tbody");
  tbody.innerHTML = "";

  answersSnap.forEach(docSnap=>{
    const data = docSnap.data();
    if (!data.set1 || !data.set2 || data.set1.length === 0 || data.set2.length === 0) {
      return;
    }
    const set1Points = calculatePoints(data.set1||[], correctData.set1||[], correctData.dobon, correctData);
    const set2Points = calculatePoints(data.set2||[], correctData.set2||[], correctData.dobon, correctData);
    const totalPoints = set1Points + set2Points;

    let createdAtText="";
    if(data.createdAt) createdAtText = data.createdAt.toDate ? data.createdAt.toDate().toLocaleString("ja-JP") : String(data.createdAt);

    const row = document.createElement("tr");
    row.innerHTML=`
      <td>${docSnap.id}</td>
      <td>${(data.set1||[]).map(v => v.num ?? v).join(", ")}</td>
<td>${(data.set2||[]).map(v => v.num ?? v).join(", ")}</td>
      <td>${totalPoints}</td>
      <td>${createdAtText}</td>
    `;
    tbody.appendChild(row);
  });
}


  // リセット機能
const resetBtn = document.getElementById("resetBtn");
resetBtn.addEventListener("click", async () => {
  // 第1確認
  const confirm = confirm("⚠️ 警告 ⚠️\n\n全ての参加者の回答を削除します。\nこの操作は取り消せません。\n\n本当に実行しますか？");
  
  if (!confirm) {
    return;
  }
  
  try {
    // answersコレクションの全ドキュメントを取得
    const answersSnap = await getDocs(collection(db, "answers"));
    
    let deletedCount = 0;
    const batch = [];
    
    // 各ドキュメントからset1とset2を削除
    for (const docSnap of answersSnap.docs) {
      const data = docSnap.data();
      
      // set1またはset2が存在する場合のみ処理
      if (data.set1 || data.set2) {
        const updateData = {};
        
        // set1が存在する場合は削除対象にする
        if (data.set1) {
          updateData.set1 = deleteField();
        }
        
        // set2が存在する場合は削除対象にする
        if (data.set2) {
          updateData.set2 = deleteField();
        }
        
        batch.push(updateDoc(doc(db, "answers", docSnap.id), updateData));
        deletedCount++;
      }
    }
    
    // 一括更新
    await Promise.all(batch);
    
    alert(`✅ リセット完了\n\n${deletedCount}件の回答を削除しました。`);
    
    // 回答一覧を再読み込み
    loadAnswers();
    
  } catch (error) {
    console.error("リセット中にエラーが発生:", error);
    alert("❌ エラーが発生しました\n\n" + error.message);
  }
});
</script>
</body>
</html>
