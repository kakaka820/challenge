<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>管理画面</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    #loginForm, #dataView { max-width: 400px; margin: auto; }
  </style>
</head>
<body>
  <h1>管理画面</h1>

  <!-- ログインフォーム -->
  <div id="loginForm">
    <h2>ログイン</h2>
    <input type="text" id="adminName" placeholder="管理者名"><br><br>
    <input type="password" id="adminPassword" placeholder="パスワード"><br><br>
    <button id="loginBtn">ログイン</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- データ表示部分 -->
<div id="dataView" style="display:none;">
  <h2>正解セット設定</h2>
  <form id="correctForm">
    <div>
      <h3>村役</h3>
      <div id="set1Options"></div>
    </div>
    <div>
      <h3>人狼</h3>
      <div id="set2Options"></div>
    </div>
    <div>
      <h3>狂人</h3>
      <div id="dobonOptions"></div>
    </div>
    <button type="submit">保存</button>
    <p id="saveMessage" style="color:green;"></p>
  </form>

  <h2>回答一覧</h2>
  <table id="answersTable">
    <thead>
      <tr>
        <th>名前（ドキュメントID）</th>
        <th>村役</th>
        <th>人狼</th>
        <th>ポイント</th>
        <th>最終更新時間</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


  <!-- Firebase SDK -->
  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries
     
    async function sha256(str) {
  const encoder = new TextEncoder();
  const data = encoder.encode(str);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  return hashHex;
}

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyDY2qQHODhC5lPN8ybWk4VoCg-ivOMiYrE",
    authDomain: "challenge-59258.firebaseapp.com",
    projectId: "challenge-59258",
    storageBucket: "challenge-59258.firebasestorage.app",
    messagingSenderId: "1035301361775",
    appId: "1:1035301361775:web:e5b29b735dd95d23c1559a",
    measurementId: "G-27VD3GZ7CT"
  };
     // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
    const db = getFirestore(app);

    const loginBtn = document.getElementById("loginBtn");
    const loginForm = document.getElementById("loginForm");
    const dataView = document.getElementById("dataView");
    const loginError = document.getElementById("loginError");

    // ログイン処理
    loginBtn.addEventListener("click", async () => {
      const name = document.getElementById("adminName").value.trim();
      const password = document.getElementById("adminPassword").value;

      if (!name || !password) {
        loginError.textContent = "名前とパスワードを入力してください";
        return;
      }
const hash = await sha256(password);

     
      // Firestore の admin コレクションから該当ユーザーを取得
      const adminRef = doc(db, "admin", name);
      const adminSnap = await getDoc(adminRef);

      if (!adminSnap.exists()) {
        loginError.textContent = "管理者が存在しません";
        return;
      }

      const adminData = adminSnap.data();
      if (adminData.pw !== hash) {
        loginError.textContent = "パスワードが正しくありません";
        return;
      }

      // 認証成功 → データ表示
      loginForm.style.display = "none";
      dataView.style.display = "block";
      loadAnswers();
    });

    // answersコレクションを読み込んで表示
    async function loadAnswers() {
  // 正解セットを取得
  const correctSnap = await getDoc(doc(db, "correct", "answers"));
  const correctData = correctSnap.exists() ? correctSnap.data() : { set1: [], set2: [], dobon: null };
  const correctSet1 = correctData.set1 || [];
  const correctSet2 = correctData.set2 || [];
  const dobon = correctData.dobon;

  const answersSnap = await getDocs(collection(db, "answers"));
  const tbody = document.querySelector("#answersTable tbody");
  tbody.innerHTML = "";

  // ポイント計算関数
  function calculatePoints(answer, correctArray, dobon) {
    let points = 0;
    answer.forEach((val, idx) => {
      if (val === dobon) {
        points -= 2;
      } else if (correctArray.includes(val)) {
        points += [6, 4, 2][idx];
      }
    });
    return points;
  }

  answersSnap.forEach(docSnap => {
    const data = docSnap.data();
    const set1Points = calculatePoints(data.set1 || [], correctSet1, dobon);
    const set2Points = calculatePoints(data.set2 || [], correctSet2, dobon);
    const totalPoints = set1Points + set2Points;

    // createdAtの処理
  let createdAtText = "";
  if (data.createdAt) {
    if (data.createdAt.toDate) {
      // Firestore Timestamp 型
      const date = data.createdAt.toDate();
      createdAtText = date.toLocaleString("ja-JP");
    } else {
      // 文字列や数値で保存されている場合
      createdAtText = String(data.createdAt);
    }
  }

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${docSnap.id}</td>
      <td>${(data.set1 || []).join(", ")}</td>
      <td>${(data.set2 || []).join(", ")}</td>
      <td>${totalPoints}</td>
      <td>${createdAtText}</td>
    `;
    tbody.appendChild(row);
  });
}

  </script>
</body>
</html>
