<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</title>
</head>
<body>
  <div id="app">
    <!-- Step 1: åå‰å…¥åŠ› -->
    <div id="step1" style="display:block;">
      <h2>åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
      <input type="text" id="nameInput" placeholder="åå‰ã‚’å…¥åŠ›">
      <button onclick="nextStep(2)">æ¬¡ã¸</button>
    </div>

    <!-- Step 2: ã‚»ãƒƒãƒˆ1 -->
    <div id="step2" style="display:none;">
      <h2>æœ€åˆã®3ã¤ã®æ•°å­—ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
      <select id="set1-1" required></select>
      <select id="set1-2" required></select>
      <select id="set1-3" required></select>
      <div>
        <button onclick="prevStep(1)">æˆ»ã‚‹</button>
        <button onclick="validateSet1()">æ¬¡ã¸</button>
      </div>
    </div>

    <!-- Step 3: ã‚»ãƒƒãƒˆ2 -->
    <div id="step3" style="display:none;">
      <h2>æ¬¡ã®3ã¤ã®æ•°å­—ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
      <select id="set2-1" required></select>
      <select id="set2-2" required></select>
      <select id="set2-3" required></select>
      <div>
        <button onclick="prevStep(2)">æˆ»ã‚‹</button>
        <button onclick="submitAnswer()">é€ä¿¡</button>
      </div>
    </div>

    <!-- Step 4: å®Œäº† -->
    <div id="step4" style="display:none;">
      <h2>å›ç­”ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼</h2>
    </div>
  </div>

  <!-- Firebase SDK -->
 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp }
    from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDY2qQHODhC5lPN8ybWk4VoCg-ivOMiYrE",
    authDomain: "challenge-59258.firebaseapp.com",
    projectId: "challenge-59258",
    storageBucket: "challenge-59258.firebasestorage.app",
    messagingSenderId: "1035301361775",
    appId: "1:1035301361775:web:e5b29b735dd95d23c1559a",
    measurementId: "G-27VD3GZ7CT"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // âœ… ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
  function showStep(step) {
    for (let i = 1; i <= 4; i++) {
      document.getElementById("step" + i).style.display = (i === step ? "block" : "none");
    }
  }

  // âœ… ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ç”¨ï¼ˆåå‰ãƒã‚§ãƒƒã‚¯è¿½åŠ ï¼‰
  window.nextStep = async function(step) {
    if (step === 2) {
      const nameValue = document.getElementById("nameInput").value.trim();
      if (!nameValue) {
        alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      // ğŸ” åŒåãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯
      const docRef = doc(db, "answers", nameValue);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        alert("ã“ã®åå‰ã¯ã™ã§ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return; // æ¬¡ã¸é€²ã¾ãªã„
      }

      // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã‘ã‚Œã°ãã®ã¾ã¾é€²ã‚€
    }
    showStep(step);
  };

  window.prevStep = function(step) {
    showStep(step);
  };

  // âœ… ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã« 1ã€œ14 ã‚’æŒ¿å…¥
  function populateSelects(prefix) {
    for (let i = 1; i <= 3; i++) {
      const select = document.getElementById(`${prefix}-${i}`);
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      for (let n = 1; n <= 14; n++) {
        select.innerHTML += `<option value="${n}">${i}ç•ªç›®: ${n}</option>`;
      }
    }
  }

  // âœ… 1ã‚»ãƒƒãƒˆç›®ã®é‡è¤‡ç¢ºèªã—ã¦ã‹ã‚‰æ¬¡ã¸
  window.validateSet1 = function() {
    const set1 = [
      document.getElementById("set1-1").value,
      document.getElementById("set1-2").value,
      document.getElementById("set1-3").value
    ];

    if (set1.includes("")) {
      alert("ã™ã¹ã¦ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    const unique = new Set(set1);
    if (unique.size !== set1.length) {
      alert("åŒã˜æ•°å­—ã‚’è¤‡æ•°é¸ã¶ã“ã¨ã¯ã§ãã¾ã›ã‚“");
      return;
    }

    nextStep(3);
  };

  // âœ… é€ä¿¡å‡¦ç†
  window.submitAnswer = async function() {
    const name = document.getElementById("nameInput").value.trim();
    const set1 = [
      document.getElementById("set1-1").value,
      document.getElementById("set1-2").value,
      document.getElementById("set1-3").value
    ];
    const set2 = [
      document.getElementById("set2-1").value,
      document.getElementById("set2-2").value,
      document.getElementById("set2-3").value
    ];

    if (!name || set1.includes("") || set2.includes("")) {
      alert("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    // âœ… ã‚»ãƒƒãƒˆ2ã‚‚é‡è¤‡ç¢ºèª
    const unique2 = new Set(set2);
    if (unique2.size !== set2.length) {
      alert("åŒã˜æ•°å­—ã‚’è¤‡æ•°é¸ã¶ã“ã¨ã¯ã§ãã¾ã›ã‚“");
      return;
    }

    try {
      await setDoc(doc(db, "answers", name), {
        set1: set1,
        set2: set2,
        createdAt: serverTimestamp()
      });
      showStep(4);
    } catch (e) {
      console.error("ä¿å­˜ã«å¤±æ•—:", e);
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    }
  };

  // âœ… åˆæœŸåŒ–
  window.addEventListener("DOMContentLoaded", () => {
    showStep(1);
    populateSelects("set1");
    populateSelects("set2");
  });
</script>

</body>
</html>
