<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>アンケート</title>
</head>
<body>
  <div id="app">
    <!-- Step 1: 名前入力 -->
    <div id="step1" style="display:block;">
      <h2>名前を入力してください</h2>
      <input type="text" id="nameInput" placeholder="名前を入力">
      <button onclick="nextStep(2)">次へ</button>
    </div>

    <!-- Step 2: セット1 -->
    <div id="step2" style="display:none;">
      <h2>最初の3つの数字を選んでください</h2>
      <select id="set1-1" required></select>
      <select id="set1-2" required></select>
      <select id="set1-3" required></select>
      <div>
        <button onclick="prevStep(1)">戻る</button>
        <button onclick="validateSet1()">次へ</button>
      </div>
    </div>

    <!-- Step 3: セット2 -->
    <div id="step3" style="display:none;">
      <h2>次の3つの数字を選んでください</h2>
      <select id="set2-1" required></select>
      <select id="set2-2" required></select>
      <select id="set2-3" required></select>
      <div>
        <button onclick="prevStep(2)">戻る</button>
        <button onclick="submitAnswer()">送信</button>
      </div>
    </div>

    <!-- Step 4: 完了 -->
    <div id="step4" style="display:none;">
      <h2>回答を受け付けました！</h2>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ✅ Firebase設定（自分のやつに差し替えてね）
    const firebaseConfig = {
      apiKey: "AIzaSyDY2qQHODhC5lPN8ybWk4VoCg-ivOMiYrE",

    authDomain: "challenge-59258.firebaseapp.com",

    projectId: "challenge-59258",

    storageBucket: "challenge-59258.firebasestorage.app",

    messagingSenderId: "1035301361775",

    appId: "1:1035301361775:web:e5b29b735dd95d23c1559a",

    measurementId: "G-27VD3GZ7CT"

    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ✅ 画面切り替え
    function showStep(step) {
      for (let i = 1; i <= 4; i++) {
        document.getElementById("step" + i).style.display = (i === step ? "block" : "none");
      }
    }

    window.nextStep = function(step) {
      showStep(step);
    };

    window.prevStep = function(step) {
      showStep(step);
    };

    // ✅ セレクトボックスに 1〜14 を挿入
    function populateSelects(prefix) {
      for (let i = 1; i <= 3; i++) {
        const select = document.getElementById(`${prefix}-${i}`);
        select.innerHTML = '<option value="">選択してください</option>';
        for (let n = 1; n <= 14; n++) {
          select.innerHTML += `<option value="${n}">${i}番目: ${n}</option>`;
        }
      }
    }

    // ✅ 1セット目の重複確認してから次へ
    window.validateSet1 = function() {
      const set1 = [
        document.getElementById("set1-1").value,
        document.getElementById("set1-2").value,
        document.getElementById("set1-3").value
      ];

      if (set1.includes("")) {
        alert("すべての項目を選択してください");
        return;
      }

      const unique = new Set(set1);
      if (unique.size !== set1.length) {
        alert("同じ数字を複数選ぶことはできません");
        return;
      }

      nextStep(3);
    };

    // ✅ 送信処理
    window.submitAnswer = async function() {
      const name = document.getElementById("nameInput").value.trim();
      const set1 = [
        document.getElementById("set1-1").value,
        document.getElementById("set1-2").value,
        document.getElementById("set1-3").value
      ];
      const set2 = [
        document.getElementById("set2-1").value,
        document.getElementById("set2-2").value,
        document.getElementById("set2-3").value
      ];

      if (!name || set1.includes("") || set2.includes("")) {
        alert("すべての項目を入力してください");
        return;
      }

      // ✅ セット2も重複確認
      const unique2 = new Set(set2);
      if (unique2.size !== set2.length) {
        alert("同じ数字を複数選ぶことはできません");
        return;
      }

      try {
        await addDoc(collection(db, "answers"), {
          name: name,
          set1: set1,
          set2: set2,
          createdAt: serverTimestamp()
        });
        showStep(4);
      } catch (e) {
        console.error("保存に失敗:", e);
        alert("エラーが発生しました");
      }
    };

    // ✅ 初期化
    window.addEventListener("DOMContentLoaded", () => {
      showStep(1);
      populateSelects("set1");
      populateSelects("set2");
    });
  </script>
</body>
</html>
